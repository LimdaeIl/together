networks:
  together-network:
    driver: bridge

volumes:
  together-mysql-volume:
  together-redis-volume:
  together-prometheus-volume:
  together-grafana-volume:

services:
  mysql:
    image: mysql:8.0
    container_name: together-mysql
    restart: unless-stopped
    ports:
      - "3377:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      TZ: "Asia/Seoul"
    command:
      - --default-time-zone=+09:00
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_0900_ai_ci
      - --sql-mode=STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION
      - --max_allowed_packet=256M
    volumes:
      - together-mysql-volume:/var/lib/mysql
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-uroot", "-p${MYSQL_ROOT_PASSWORD}" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    networks:
      - together-network

  redis:
    image: redis:7.2-alpine
    container_name: together-redis
    restart: unless-stopped
    ports:
      - "6379:6379"        # spring.data.redis.host=localhost, port=6379 매칭
    environment:
      TZ: Asia/Seoul
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}            # ""면 인증 미사용
      REDIS_MAXMEMORY: ${REDIS_MAXMEMORY:-512mb}     # 로컬 기본 512MB
      REDIS_MAXMEMORY_POLICY: ${REDIS_MAXMEMORY_POLICY:-allkeys-lru}
    command: >
      sh -c 'exec redis-server
             --appendonly yes
             --appendfsync everysec
             --save 900 1 --save 300 10 --save 60 10000
             --maxmemory ${REDIS_MAXMEMORY:-512mb}
             --maxmemory-policy ${REDIS_MAXMEMORY_POLICY:-allkeys-lru}
             ${REDIS_PASSWORD:+--requirepass $REDIS_PASSWORD}'
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -h 127.0.0.1 -p 6379 ${REDIS_PASSWORD:+-a $REDIS_PASSWORD} ping | grep PONG"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
    volumes:
      - together-redis-volume:/data
      # 아직 redis.conf 파일을 만들지 않았으니 일단 주석 유지
      # 만들었다면 위치는 ./docker/redis/redis.conf 로 맞추세요
      # - ./docker/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - together-network

  prometheus:
    image: prom/prometheus:latest
    container_name: together-prometheus
    restart: unless-stopped
    ports:
      - "9097:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - together-prometheus-volume:/prometheus
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - together-network

  grafana:
    image: grafana/grafana:latest
    container_name: together-grafana
    restart: unless-stopped
    ports:
      - "3007:3000"
    environment:
      TZ: Asia/Seoul
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD}
    volumes:
      - together-grafana-volume:/var/lib/grafana
    depends_on:
      - prometheus
    networks:
      - together-network